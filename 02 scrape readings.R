# html analysis # %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

# ordinary days with 1 set of readings:

'<div class="card mb-2" id="20230104"> 
  <div class="card-body"> 
    <a href="/dzien/2023-01-04" data-clicksmap="site:liturgia - LiturgiaYear - /liturgia/2023-01-04" class="liturgia-powszedni"> 
      <div class="row kalendarz-year"> 
        <div class="col-12 col-md-2 text-center p-0"> 
          
          <h3 class="lh-1 color-text color-powszedni"> <span class="fs-1">4</span> <br>
          <span class="fs-6">środa</span> </h3>   
          
        </div> 
            <div class="col-12 col-md-10"> 
            <p class="fs-6 m-0 font-sans"> Kolor szat: <span>biały</span> </p> 
            <p class="text-left mb-2 lh-sm font-serif fw-bold color-powszedni">Dzień Powszedni</p> 
            
            <p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; ">
            <strong>Nowy lekcjonarz:</strong> 1 J 3, 7-10; Ps 98 (97), 1bcde. 7-8. 9 (R.: por. 3cd); Por. Hbr 1, 1-2a; J 1, 35-42; </p> 
            <p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; ">
            <strong>Stary lekcjonarz:</strong> 1 J 3, 7-10; Ps 98, 1, 7-8, 9; Hbr 1, 1-2; J 1, 35-42; </p> 
            </div> 
      </div> 
    </a> 
  </div> 
</div>
'
# days with 2 sets of readings (memorials - wspomnienie)
'
 <p style="margin:5px 0 0 0; padding:0;font-size: 0.9em; font-weight:bold; text-transform: uppercase;">Z dnia</p>
 <p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; ">
 <strong>Nowy lekcjonarz:</strong> 1 J 2, 29 – 3, 6; Ps 98 (97), 1bcde. 3c-4. 5-6 (R.: por. 3cd); J 1, 14a. 12a; J 1, 29-34; </p>
 <p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; ">
 <strong>Stary lekcjonarz:</strong> 1 J 2, 29 – 3, 6; Ps 98, 1, 3cd-4, 5-6; J 1, 14. 12; J 1, 29-34; </p>
 <p style="margin:5px 0 0 0; padding:0;font-size: 0.9em; font-weight:bold; text-transform: uppercase;">ze wspomnienia</p>
 <p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; ">
 <strong>Nowy lekcjonarz:</strong> Flp 2, 1-11; Ps 8, 4-5. 6-7. 8-9 (R.: 2ab); Por. Mt 1, 21; Łk 2, 21-24; </p>
 <p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; ">
 <strong>Stary lekcjonarz:</strong> Flp 2, 1-11; Ps 8, 4-5. 6-7. 8-9 (R.: por. 2a); Mt 1, 21; Łk 2, 21-24; </p>
                                              
'
# days with more than 2 sets of readings: feasts e.g. Easter
'
<div class="card-body">                    
<a href="/dzien/2025-12-25" data-clicksmap="site:liturgia - LiturgiaYear - /liturgia/2025-12-25" class="liturgia-niedziela">
<div class="row kalendarz-year">
  <div class="col-12 col-md-2 text-center p-0">
  <h3 class="lh-1 color-text color-niedziela">                                
  <span class="fs-1">25</span>
  <br><span class="fs-6">czwartek</span></h3>
  </div>
  <div class="col-12 col-md-10">
  <p class="fs-6 m-0 font-sans">Kolor szat: <span>biały</span></p>
<p class="text-left mb-2 lh-sm font-serif fw-bold color-niedziela">Uroczystość Narodzenia Pańskiego</p> 

<p style="margin:5px 0 0 0; padding:0;font-size: 0.9em; font-weight:bold; text-transform: uppercase;">Msza Wigilii</p>                                                                                            
<p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; "><strong>Nowy lekcjonarz:</strong> Iz 62, 1-5; Ps 89 (88), 4-5. 16-17. 27 i 29 (R.: por. 2a); Dz 13, 16-17. 22-25; ; Mt 1, 1-25; </p>
<p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; "><strong>Stary lekcjonarz:</strong> Iz 62, 1-5; Ps 89, 4-5. 16-17. 27 i 29 (R.: por. 2a); Dz 13, 16-17. 22-25; ; Mt 1, 1-25; </p>

<p style="margin:5px 0 0 0; padding:0;font-size: 0.9em; font-weight:bold; text-transform: uppercase;">Msza w nocy</p>
<p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; "><strong>Nowy lekcjonarz:</strong> Iz 9, 1-3. 5-6; Ps 96 (95), 1-2a. 2b-3. 11-12. 13 (R.: por. Łk 2, 11); Tt 2, 11-14; ; Łk 2, 1-14; </p>
<p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; "><strong>Stary lekcjonarz:</strong> Iz 9, 1-3. 5-6; Ps 96, 1-2. 3 i 10ac. 11-12. 13 (R.: por. Iz 11); Tt 2, 11-14; Łk 2, 10-11; Łk 2, 1-14; </p>
                                              
<p style="margin:5px 0 0 0; padding:0;font-size: 0.9em; font-weight:bold; text-transform: uppercase;">Msza o świcie</p>
<p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; "><strong>Nowy lekcjonarz:</strong> Iz 62, 11-12; Ps 97 (96), 1 i 6. 11-12; Tt 3, 4-7; Łk 2, 14; Łk 2, 15-20; </p>
<p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; "><strong>Stary lekcjonarz:</strong> Iz 62, 11-12; Ps 97, 1 i 6. 11-12; Tt 3, 4-7; Łk 2, 14; Łk 2, 15-20; </p>
                                              
<p style="margin:5px 0 0 0; padding:0;font-size: 0.9em; font-weight:bold; text-transform: uppercase;">Msza w dzień</p>
<p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; "><strong>Nowy lekcjonarz:</strong> Iz 52, 7-10; Ps 98 (97), 1bcde. 2-3b. 3c-4. 5-6 (R.: por. 3cd); Hbr 1, 1-6; ; J 1, 1-18; </p>
<p class="text-left font-sans" style="margin:0; padding:0;font-size: 0.9em; font-weight:normal; "><strong>Stary lekcjonarz:</strong> Iz 52, 7-10; Ps 98, 1. 2-3ab. 3cd-d. 5-6 (R.: 3c); Hbr 1, 1-6; ; J 1, 1-18; </p>
                                              
</div>
</div>
</a>
</div>
</div>
'

# the scraping functions

clean_readings <- function(raw_items) {
  tibble(raw = raw_items) %>%
    mutate(
      clean = str_squish(raw),
      day = str_match(clean, "^(\\d+)\\s+([^/]+?)\\s*/")[,3],
      status = str_extract(clean, "(?<=/)\\s*[^/]+(?=/)") |> str_trim(),
      readings = str_match(clean, "/[^/]+/\\s*(.*)$")[,2], 
      readings = str_remove(readings, ";$")
    ) |> 
    select(day, status, readings)
}

scrape_readings <- function(year) {
  
  url <- paste0("https://niezbednik.niedziela.pl/liturgia/", year, "-", '01')
  webpage <- readLines(url)
  doc <- htmlParse(webpage, asText = TRUE)
  
  ids <- xpathSApply(doc, "//div[@class='card mb-2']", xmlGetAttr, "id")
  node <- paste0("//div[contains(@class, 'card') and contains(@id, '", year, "')]")
  
  liturgy_items <- xpathSApply(doc, node, function(node) {
    date <- xpathSApply(node, ".//h3[contains(@class, 'color')] ", xmlValue)
    status <- xpathSApply(node, ".//p[contains(@class, 'text-left mb-2')] ", xmlValue)
    
    # All cases of Nowy lekcjonarz (1 or 2 sets)
    readings <- xpathSApply(node, 
                            ".//p[contains(@class, 'text-left') and contains(., 'Nowy lekcjonarz:')]", 
                            xmlValue)
    
    # Clean and combined different sets of readings
    if(length(readings) > 0) {
      
      readings <- gsub("^\\s*Nowy lekcjonarz:\\s*", "", trimws(readings))
      readings <- gsub("\\s+", " ", readings)
      
      if(length(readings) == 4) {
        readings_combined <- paste(readings[1], readings[2], readings[3], readings[4], sep = " ")
      } else if(length(readings) == 3) {
        readings_combined <- paste(readings[1], readings[2], readings[3], sep = " ")
      } else if(length(readings) == 2) {
        readings_combined <- paste(readings[1], readings[2],  sep = " ")
      } else {
        readings_combined <- readings[1]
      }
      paste(date, status, readings_combined, sep = "/ ")
    }
  })
  
  readings <- clean_readings(liturgy_items) 
  
  output <- data.frame(
    date = ids, 
    day = readings$day, 
    status = readings$status,
    readings = readings$readings,
    stringsAsFactors = FALSE
  )
}

# scrape readings from 2022 to 2025

liturgical_readings <- setNames(lapply(2022:2025, scrape_readings), 
                                paste0("y", 2022:2025))

# create liturgical years

'
year 2022/2023 - A, 
year 2023/2024 - B, 
year 2024/2025 - C,

The liturgical year starts with the 1st Vespers (evening prayer) of the First Sunday of Advent

A - 27.11.2022 - 02.12.2023
B - 03.12.2023 - 30.11.2024
C - 01.12.2024 - 29.11.2025'

y_a <- liturgical_readings$y2022[331:365, ]
y_a <- rbind(y_a, liturgical_readings$y2023[1:336,])
y_b <- liturgical_readings$y2023[337:365,]
y_b <- rbind(y_b, liturgical_readings$y2024[1:335,])
y_c <- liturgical_readings$y2024[336:366,]
y_c <- rbind(y_c, liturgical_readings$y2025[1:333,])

y_a$year <- "A"
y_b$year <- "B"
y_c$year <- "C"

yrs_abc <- rbind(y_a, y_b, y_c)
yrs_abc <- yrs_abc[,c(5,1:4)]

days <- unique(yrs_abc$day)
days_short <- c("Sun", "Mon", "Tue", "Wed","Thu", "Fri","Sat")
replacement_vec <- setNames(days_short, days)
yrs_abc$day <- str_replace_all(yrs_abc$day, replacement_vec)

rownames(yrs_abc) <- seq_len(nrow(yrs_abc))

rm(liturgical_readings, y_a, y_b, y_c, days, days_short, replacement_vec)